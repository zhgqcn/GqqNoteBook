# æ¨¡å‹æµ‹è¯•ä¸­çš„ä»£ç ç†è§£

> æ¨¡å‹è®­ç»ƒä¹‹åï¼Œæµ‹è¯•æ˜¯é‡ä¸­ä¹‹é‡ï¼Œç›®å‰ï¼Œæˆ‘æ‰€ç¢°åˆ°çš„æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
>
> > ğŸ…°åˆ©ç”¨`torchvision.utils.save_image`æ¥å¯¹æ¨¡å‹ç»“æœç›´æ¥è¿›è¡Œä¿å­˜
> >
> > ğŸ…±å…ˆå°†ç»“æœè½¬æ¢ä¸º`numpy array`ä¹‹åè¿›è¡Œæå–ä¸åˆæˆ



## åˆ©ç”¨`torchvision.util.save_image`è¿›è¡Œæµ‹è¯•

> äº†è§£æºç è¯·çœ‹å®˜æ–¹æ–‡æ¡£[ğŸ“’](https://pytorch.org/docs/stable/_modules/torchvision/utils.html#save_image)

1. è‹¥æ¨¡å‹çš„è¾“å‡ºæ˜¯ä¸‰é€šé“çš„`RGB`å›¾åƒï¼Œé‚£ä¹ˆç›´æ¥åˆ©ç”¨

```python
torchvision.utils.save_image(model_out, './out.png', padding=0)
```

2. è‹¥æ¨¡å‹æ˜¯å•é€šé“çš„è¾“å‡ºæ—¶ï¼Œåˆ™éœ€è¦åšä¸€äº›æƒ³è¦çš„å˜åŒ–å·¥ä½œï¼š

```python
HR_2_r = model_r(r) 
HR_2_g = model_g(g)

black_2 = torch.zeros(1, 1024, 1024).unsqueeze(0).cuda()
HR_2 = torch.cat((HR_2_r.squeeze(0), HR_2_g.squeeze(0), black_2.squeeze(0))).unsqueeze(0)

torchvision.utils.save_image(HR_2, './out.png', padding=0)
print("saved !")
```

- å‡è®¾ç»è¿‡æ¨¡å‹è®¡ç®—åçš„`HR_2_r.shape`ï¼š`[1, 1, 1024, 1024]`
- å‡è®¾ç»è¿‡æ¨¡å‹è®¡ç®—åçš„`HR_2_g.shape`ï¼š`[1, 1, 1024, 1024]`

- åˆ›å»º`black_2`æ˜¯å› ä¸ºæƒ³è·å¾—å…¨é»‘è‰²æ— ä¿¡æ¯çš„`Bé€šé“`è€Œåç»“åˆæ¨¡å‹è¾“å‡ºçš„`R and G`é€šé“æ¥ç”Ÿæˆ`RGB`çš„å›¾åƒï¼Œåˆ©ç”¨`unsqueeze(0)`æ¥ä½¿å¾—`torch.zeros(1, 1024, 1024)`çš„å½¢çŠ¶å˜æˆ`[1, 1, 1024, 1024]`ï¼Œä½¿å…¶ä¸å…¶ä»–ä¸¤ä¸ªé€šé“ç›¸åŒä»¥ä¾¿äºåˆå¹¶
- `HR_2_r.squeeze(0)`ä½¿å¾—å…¶å½¢çŠ¶ç”±`[1, 1, 1024, 1024]`å˜ä¸º`[1, 1024, 1024]`ï¼Œå…¶ä»–åŒç†ã€‚ä¹‹ååˆ©ç”¨`torch.cat`æ¥è¿›è¡Œ**åˆå¹¶é€šé“**ï¼Œæœ€åä½¿ç”¨`torchvision.utils.save_image`æ¥è¿›è¡Œä¿å­˜ã€‚



# åˆ©ç”¨`numpy array`æ¥ä¿å­˜å›¾åƒ

```python
model = torch.load(opt.model).cuda()

transform = Compose([ToTensor(), Lambda(lambda x: x.repeat(3,1,1)),])

img = Image.open(opt.input).convert('RGB')
LR_r_spilt, _, _ = img.split()

LR_r = transform(LR_r_spilt)

LR_r = LR_r.unsqueeze(0)

LR_r = LR_r.cuda()
HR_2_r = model(LR_r)
HR_2_r = HR_2_r.cpu()

out_HR_2_r_detach = HR_2_r.data[0].numpy() 

out_HR_2_r = out_HR_2_r_detach * 255.0

out_HR_2_r = out_HR_2_r.clip(0, 255)

out_HR_2_r_result = Image.fromarray(np.uint8(out_HR_2_r[0]), mode='L')

out_HR_2_r_result.save(opt.outputHR2)
print('output image saved to ', opt.outputHR2)
```

- å‡è®¾`img.size`ä¸º`[3, 512, 512]`ï¼Œç»è¿‡`split`åï¼Œ`LR_r_spilt.size`ä¸º`[512, 512]`ï¼Œå†ç»è¿‡`transform`åï¼Œåˆ™æ¨¡å‹çš„è¾“å…¥`LR_r.shape`:`torch.Size([3, 512, 512])`ï¼Œä½†æ˜¯ç½‘ç»œçš„è¾“å…¥åº”è¯¥æ˜¯`[batchSize, C, H, W]`çš„4ç»´å‘é‡ï¼Œæ‰€ä»¥è¦è¿›è¡Œ`unsqueeze(0)`æ“ä½œï¼Œä½¿å¾—`LR_r`å˜ä¸º`torch.Size([1, 3, 512, 512])`
- ç»è¿‡æ¨¡å‹è®¡ç®—åçš„`HR_2_r.shape`ï¼š`torch.Size([1, 3, 1024, 1024])`ï¼Œå› ä¸ºæ¨¡å‹æ˜¯åˆ©ç”¨`torch`è®¡ç®—çš„ï¼Œåœ¨è¿›è¡Œ`numpy`è½¬æ¢å‰ï¼Œåº”è¯¥å…ˆç”¨`.cpu()`åšä¸€ä¸ªæ•°æ®çš„è½¬æ¢
- åˆ©ç”¨`HR_2_r.data[0]`æ˜¯å¯¹æ•°æ®è¿›è¡Œåˆ†ç¦»ï¼Œä½¿å¾—å››ç»´çš„æ•°æ®å˜æˆä¸‰ç»´`torch.Size([3, 1024, 1024])`ã€‚å½“ç„¶ä¹Ÿæœ‰ä½¿ç”¨`detach()`æ¥è¿›è¡Œè¿™æ ·æ“ä½œ[ğŸ‘‰MORE](https://stackoverflow.com/questions/49768306/pytorch-tensor-to-numpy-array)
- ç”±äºç½‘ç»œçš„ç»“æœæ˜¯`[0, 1]`ä¹‹é—´çš„å€¼ï¼Œè€Œä¹‹åè¦åˆ©ç”¨`np.unit8()`åšè½¬æ¢ï¼Œæ‰€ä»¥è¦å°†ç»“æœè½¬ä¸º`[0, 255]`ä¹‹é—´ï¼Œæ‰€ä»¥è¦ä¹˜ä»¥`255.0`ã€‚è€Œä¹˜ä»¥255åå¯èƒ½ä½¿å¾—æ•°æ®å¤§äº255ï¼Œæ•…ç”¨`clip(0, 255)`æ¥ä¿è¯æ•°æ®åŸŸæ˜¯æ­£ç¡®çš„
- åˆ©ç”¨`out_HR_2[0]`æ¥æå–**ç¬¬ä¸€**é€šé“ï¼Œå³`Ré€šé“`ï¼Œæœ€ååˆ©ç”¨`Image.fromarray`æ¥å®ç°ä»`array`åˆ°`Image`çš„è½¬å˜ï¼Œæ­¤æ—¶ï¼Œ`out_HR_r_result`å³ä¸ºå•é€šé“çš„ç°åº¦å›¾

ä»¥ä¸‹æ˜¯æµ‹è¯•è¾“å‡ºï¼Œå¯ä»¥ä¸çœ‹ï¼š

```shell
Namespace(cuda=True, input='/content/drive/My Drive/TestImg/val/95-512pix-speed7-ave1.tif', model='/content/drive/My Drive/TestImg/H_Adagrad_epoch_r_400.pth', outputHR2='/content/drive/My Drive/TestImg/val2/95_X2.tif', outputHR4='/content/drive/My Drive/TestImg/val4/95_X4.tif')
After Split:(512, 512)
After transform:torch.Size([3, 512, 512])
After unsqueeze:torch.Size([1, 3, 512, 512])
After Model:torch.Size([1, 3, 1024, 1024])
After data[0]:torch.Size([3, 1024, 1024])
After data[0].numpy():(3, 1024, 1024)

# ç½‘ç»œè¾“å‡º
[[[0.0726895  0.05225104 0.05731031 ... 0.08038348 0.09176005 0.11681005]
  [0.05010414 0.03608295 0.05038059 ... 0.07422554 0.08273476 0.09623137]
  [0.05970517 0.04536656 0.04714845 ... 0.07344079 0.07673076 0.08257505]
  ...
  [0.10552698 0.10863981 0.1160759  ... 0.07840011 0.05360675 0.05854338]
  [0.12117186 0.11651129 0.12565961 ... 0.06953818 0.03986105 0.05407226]
  [0.13890806 0.13018039 0.12679848 ... 0.07166685 0.05829817 0.08199665]]

 [[0.06548429 0.04780073 0.05077077 ... 0.07777905 0.08438891 0.08978723]
  [0.04724503 0.03454134 0.04663415 ... 0.07442069 0.07981256 0.08830814]
  [0.05518261 0.04601964 0.04341775 ... 0.07343534 0.07746741 0.07461968]
  ...
  [0.10186043 0.10778397 0.11563006 ... 0.07755548 0.05533218 0.04998586]
  [0.11432448 0.11585081 0.12556481 ... 0.06927705 0.04027918 0.04754832]
  [0.12643194 0.12204635 0.12268594 ... 0.06363812 0.05656445 0.07072814]]

 [[0.06303221 0.04812427 0.05175997 ... 0.0773088  0.08727033 0.09965152]
  [0.04497686 0.03826225 0.04548033 ... 0.07697698 0.08157301 0.09077145]
  [0.05506983 0.04517868 0.04388288 ... 0.07452801 0.07780927 0.07592566]
  ...
  [0.10016826 0.10798413 0.11497539 ... 0.078601   0.05558252 0.05430539]
  [0.11343104 0.11644471 0.12352681 ... 0.06749362 0.03726557 0.0477092 ]
  [0.125687   0.12345901 0.12515822 ... 0.06406513 0.05620003 0.0672472 ]]]
  

# ä¹˜ä»¥ 255
[[[18.535824  13.324016  14.61413   ... 20.497787  23.398813  29.786564 ]
  [12.776556   9.201153  12.84705   ... 18.927513  21.097364  24.539    ]
  [15.224818  11.568472  12.022855  ... 18.727402  19.566343  21.056639 ]
  ...
  [26.90938   27.70315   29.599356  ... 19.992027  13.669721  14.928563 ]
  [30.898825  29.710379  32.0432    ... 17.732235  10.164569  13.788426 ]
  [35.421555  33.196     32.333614  ... 18.275047  14.866034  20.909145 ]]

 [[16.698492  12.189187  12.9465475 ... 19.833658  21.519173  22.895744 ]
  [12.047482   8.808042  11.891709  ... 18.977276  20.352201  22.518576 ]
  [14.071565  11.735009  11.071527  ... 18.726011  19.75419   19.028019 ]
  ...
  [25.974411  27.484913  29.485666  ... 19.776648  14.109707  12.746393 ]
  [29.152742  29.541956  32.019028  ... 17.665648  10.271191  12.124823 ]
  [32.240147  31.12182   31.284914  ... 16.22772   14.423935  18.035675 ]]

 [[16.073214  12.271688  13.198793  ... 19.713745  22.253935  25.411137 ]
  [11.469099   9.756873  11.597483  ... 19.629131  20.801117  23.14672  ]
  [14.042808  11.520564  11.190133  ... 19.004642  19.841366  19.361044 ]
  ...
  [25.542906  27.535952  29.318726  ... 20.043255  14.173544  13.847875 ]
  [28.924913  29.6934    31.499336  ... 17.210873   9.50272   12.165845 ]
  [32.050186  31.482048  31.915346  ... 16.336607  14.331007  17.148035 ]]]

# clipä¹‹å
[[[18.535824  13.324016  14.61413   ... 20.497787  23.398813  29.786564 ]
  [12.776556   9.201153  12.84705   ... 18.927513  21.097364  24.539    ]
  [15.224818  11.568472  12.022855  ... 18.727402  19.566343  21.056639 ]
  ...
  [26.90938   27.70315   29.599356  ... 19.992027  13.669721  14.928563 ]
  [30.898825  29.710379  32.0432    ... 17.732235  10.164569  13.788426 ]
  [35.421555  33.196     32.333614  ... 18.275047  14.866034  20.909145 ]]

 [[16.698492  12.189187  12.9465475 ... 19.833658  21.519173  22.895744 ]
  [12.047482   8.808042  11.891709  ... 18.977276  20.352201  22.518576 ]
  [14.071565  11.735009  11.071527  ... 18.726011  19.75419   19.028019 ]
  ...
  [25.974411  27.484913  29.485666  ... 19.776648  14.109707  12.746393 ]
  [29.152742  29.541956  32.019028  ... 17.665648  10.271191  12.124823 ]
  [32.240147  31.12182   31.284914  ... 16.22772   14.423935  18.035675 ]]

 [[16.073214  12.271688  13.198793  ... 19.713745  22.253935  25.411137 ]
  [11.469099   9.756873  11.597483  ... 19.629131  20.801117  23.14672  ]
  [14.042808  11.520564  11.190133  ... 19.004642  19.841366  19.361044 ]
  ...
  [25.542906  27.535952  29.318726  ... 20.043255  14.173544  13.847875 ]
  [28.924913  29.6934    31.499336  ... 17.210873   9.50272   12.165845 ]
  [32.050186  31.482048  31.915346  ... 16.336607  14.331007  17.148035 ]]]

# æå–ç¬¬ä¸€é€šé“
[[18.535824 13.324016 14.61413  ... 20.497787 23.398813 29.786564]
 [12.776556  9.201153 12.84705  ... 18.927513 21.097364 24.539   ]
 [15.224818 11.568472 12.022855 ... 18.727402 19.566343 21.056639]
 ...
 [26.90938  27.70315  29.599356 ... 19.992027 13.669721 14.928563]
 [30.898825 29.710379 32.0432   ... 17.732235 10.164569 13.788426]
 [35.421555 33.196    32.333614 ... 18.275047 14.866034 20.909145]]
After PostDeal:(1024, 1024)
output image saved to  /content/drive/My Drive/TestImg/val2/95_X2.tif
output image saved to  /content/drive/My Drive/TestImg/val4/95_X4.tif
```



